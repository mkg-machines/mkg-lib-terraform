name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  TERRAFORM_VERSION: "1.6.0"
  TFLINT_VERSION: "v0.60.0"

jobs:
  format:
    name: Terraform Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive -diff

  validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        module:
          - lambda
          - dynamodb
          - s3
          - sqs
          - eventbridge
          - api-gateway
          - extension
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        working-directory: modules/${{ matrix.module }}
        run: terraform init -backend=false

      - name: Terraform Validate
        working-directory: modules/${{ matrix.module }}
        run: terraform validate

  tflint:
    name: TFLint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: ${{ env.TFLINT_VERSION }}

      - name: Init TFLint
        run: tflint --init --config=.tflint.hcl

      - name: Run TFLint
        run: |
          for module in modules/*/; do
            echo "Linting $module"
            tflint --chdir="$module" --config="$(pwd)/.tflint.hcl" --format=compact
          done

  checkov:
    name: Checkov Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: modules/
          framework: terraform
          output_format: cli
          soft_fail: false
          # Skip checks that don't apply to reusable module libraries:
          # - CKV_TF_1: Module sources use commit hash (we use versioned releases)
          # - CKV_AWS_309: API Gateway authorization (intentionally configurable)
          # - CKV_AWS_158: CloudWatch Log Group KMS (optional, cost implications)
          # - CKV_AWS_116: Lambda DLQ (optional feature)
          # - CKV_AWS_272: Lambda code signing (enterprise feature)
          # - CKV_AWS_173: Lambda env vars encryption (optional KMS)
          # - CKV_AWS_300: S3 lifecycle abort multipart (not always needed)
          # - CKV_AWS_145: S3 KMS encryption (SSE-S3 is acceptable)
          # - CKV_AWS_18: S3 access logging (optional feature)
          # - CKV_AWS_144: S3 cross-region replication (expensive, optional)
          # - CKV2_AWS_62: S3 event notifications (optional feature)
          skip_check: CKV_TF_1,CKV_AWS_309,CKV_AWS_158,CKV_AWS_116,CKV_AWS_272,CKV_AWS_173,CKV_AWS_300,CKV_AWS_145,CKV_AWS_18,CKV_AWS_144,CKV2_AWS_62

  terraform-docs:
    name: Terraform Docs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup terraform-docs
        run: |
          mkdir -p /tmp/terraform-docs
          curl -sSLo /tmp/terraform-docs/terraform-docs.tar.gz https://terraform-docs.io/dl/v0.19.0/terraform-docs-v0.19.0-linux-amd64.tar.gz
          tar -xzf /tmp/terraform-docs/terraform-docs.tar.gz -C /tmp/terraform-docs
          chmod +x /tmp/terraform-docs/terraform-docs
          sudo mv /tmp/terraform-docs/terraform-docs /usr/local/bin/

      - name: Run terraform-docs
        run: |
          for module in modules/*/; do
            terraform-docs -c .terraform-docs.yml "$module"
          done

      - name: Check for changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "::error::README.md files are out of date. Run 'terraform-docs' locally and commit the changes."
            git diff
            exit 1
          fi

  # Summary Job
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [format, validate, tflint, checkov, terraform-docs]
    steps:
      - name: CI Passed
        run: echo "All CI checks passed!"
